name: Appium CI

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2

      - name: Set up JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: 1.8

      - name: Set APK Path
        run: echo "APK_PATH=$(echo $GITHUB_WORKSPACE)/app/app-koalaLabs-staging-release.apk" >> $GITHUB_ENV

      - name: Install AVD files
        run: |
          yes | $ANDROID_HOME/tools/bin/sdkmanager --install 'system-images;android-29;default;x86_64'
          yes | $ANDROID_HOME/tools/bin/sdkmanager --licenses

      - name: Create Android emulator
        run: |
          echo "no" | $ANDROID_HOME/tools/bin/avdmanager create avd -n Pixel_API_29_AOSP -d pixel --package 'system-images;android-29;default;x86_64' --force
          emulator_config=~/.android/avd/Pixel_API_29_AOSP.avd/config.ini
          sed -i .bak 's/hw.lcd.density=.*/hw.lcd.density=420/' "$emulator_config"
          sed -i .bak 's/hw.lcd.height=.*/hw.lcd.height=1920/' "$emulator_config"
          sed -i .bak 's/hw.lcd.width=.*/hw.lcd.width=1080/' "$emulator_config"
          if ! grep -q "hw.lcd.density" "$emulator_config"; then
            echo "hw.lcd.density=420" >> "$emulator_config"
          fi
          if ! grep -q "hw.lcd.height" "$emulator_config"; then
            echo "hw.lcd.height=1920" >> "$emulator_config"
          fi
          if ! grep -q "hw.lcd.width" "$emulator_config"; then
            echo "hw.lcd.width=1080" >> "$emulator_config"
          fi

      - name: Start Android emulator
        run: |
          nohup $ANDROID_HOME/emulator/emulator -avd Pixel_API_29_AOSP -no-snapshot -no-window -no-audio -no-boot-anim -camera-back none -camera-front none -qemu -m 2048 > /dev/null 2>&1 &
          $ANDROID_HOME/platform-tools/adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed | tr -d '\r') ]]; do sleep 1; done; input keyevent 82'

      - name: Install Appium
        run: |
          sudo npm install -g appium
          sudo npm install -g appium@1.22.3
          sudo npm install -g appium-doctor

      - name: Start Appium Server with ChromeDriver Autodownload
        run: appium server --allow-insecure chromedriver_autodownload && appium --allow-insecure=adb_security --port 4723 --address 0.0.0.0 & appium-doctor
      - name: Check Appium Server
        run: |
          nc -zv 127.0.0.1 4723 && echo "Appium server is running" || echo "Appium server is not running"
      - name: Check Appium Server
        run: pgrep -f "appium" || echo "Appium server is not running"

      - name: Run TestNG Tests
        run: mvn test
